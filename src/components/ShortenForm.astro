---
import Button from "./Button.astro";
import Input from "./Input.astro";
---

<form id="shorten-form" class="w-full max-w-lg mt-2">
  <div
    class="flex items-center gap-2 bg-surface rounded-full px-5 py-2.5 border border-accent/15"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="20"
      height="20"
      fill="none"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      class="text-secondary shrink-0"
      viewBox="0 0 24 24"
      ><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
      ></path><path
        d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
      ></path></svg
    >
    <Input
      name="url"
      type="url"
      placeholder="Pega tu URL larga aquí..."
      required={true}
      class="flex-1 py-1"
    />
    <Button type="submit" variant="primary">Acortar</Button>
  </div>
</form>

<script>
  import { actions, isInputError } from "astro:actions";

  const form = document.getElementById("shorten-form") as HTMLFormElement;
  const submitBtn = form?.querySelector(
    'button[type="submit"]',
  ) as HTMLButtonElement;
  const resultContainer = document.getElementById("shorten-result");
  const resultUrl = document.getElementById("shorten-url");
  const errorContainer = document.getElementById("shorten-error");
  const errorMessage = document.getElementById("error-message");
  const copyBtn = document.getElementById("copy-btn");
  const copyText = document.getElementById("copy-text");

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const url = formData.get("url") as string;

    submitBtn.disabled = true;
    const originalBtnText = submitBtn.textContent;
    submitBtn.textContent = "Acortando...";

    resultContainer?.classList.add("hidden");
    errorContainer?.classList.add("hidden");

    const { data, error } = await actions.shortenUrl({ url });

    submitBtn.disabled = false;
    submitBtn.textContent = originalBtnText;

    if (error) {
      let message: string;

      if (isInputError(error)) {
        message = error.fields.url?.join(", ") || "URL inválida.";
      } else {
        message = error.message;
      }

      if (errorMessage) errorMessage.textContent = message;
      errorContainer?.classList.remove("hidden");
      return;
    }

    if (data && resultUrl) {
      const shortUrl = `${window.location.origin}/${data.id}`;
      resultUrl.textContent = shortUrl;
      resultUrl.setAttribute("data-url", shortUrl);
    }

    resultContainer?.classList.remove("hidden");
    form.reset();
  });

  copyBtn?.addEventListener("click", async () => {
    const url =
      resultUrl?.getAttribute("data-url") || resultUrl?.textContent || "";

    try {
      await navigator.clipboard.writeText(url);
      if (copyText) {
        copyText.textContent = "¡Copiado!";
        setTimeout(() => {
          copyText.textContent = "Copiar";
        }, 2000);
      }
    } catch {
      if (copyText) copyText.textContent = "Error";
    }
  });
</script>
